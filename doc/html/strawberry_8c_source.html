<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>fdbc: strawberry.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>strawberry.c</h1><a href="strawberry_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Author: vyouzhi &lt;vyouzhi@163.com&gt;</span>
<a name="l00003"></a>00003 <span class="comment"> * http://www.xda.cn</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * File: snooker.c</span>
<a name="l00006"></a>00006 <span class="comment"> * Create Date: 2012-08-03 14:16:16</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> */</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;error.h&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="log__lib_8h.html">log_lib.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="thread__lib_8h.html">thread_lib.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="conf__lib_8h.html">conf_lib.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="action__lib_8h.html">action_lib.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="daemon__lib_8h.html">daemon_lib.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="signal__lib_8h.html">signal_lib.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="config__global_8h.html">config_global.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="modules_8h.html">./modules/modules.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="pool__init_8h.html">./hashtable/pool_init.h</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="strawberry_8c.html#a0ddf1224851353fc92bfbff6f499fa97">00021</a> <span class="keywordtype">int</span> <a class="code" href="test__hashtable_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]){
<a name="l00022"></a>00022     <span class="keywordtype">int</span> listen_fd, unix_sock;
<a name="l00023"></a>00023     pid_t pid;
<a name="l00024"></a>00024     <span class="keywordtype">int</span> fds[2];
<a name="l00025"></a>00025         <span class="keywordtype">int</span> h, max_ring_queue;
<a name="l00026"></a>00026         <span class="keywordtype">char</span> *c, pid_file[500], buf[1];
<a name="l00027"></a>00027         ssize_t do_daemonize = 0;
<a name="l00028"></a>00028     <span class="keyword">extern</span> <span class="keywordtype">int</span> process_num;
<a name="l00029"></a>00029     <span class="keywordtype">char</span> help[]=<span class="stringliteral">&quot; -c etc/suning.cnf\n \</span>
<a name="l00030"></a>00030 <span class="stringliteral">                Usage: \n \</span>
<a name="l00031"></a>00031 <span class="stringliteral">                -c which loading suning.cnf \n \</span>
<a name="l00032"></a>00032 <span class="stringliteral">                -d daemon run \n&quot;</span>;
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 
<a name="l00035"></a>00035     <a class="code" href="signal__lib_8c.html#ace90bd05c3b7f2bf7a7134cd87f0bce6">set_signal</a>();
<a name="l00036"></a>00036 
<a name="l00037"></a>00037     <span class="keywordflow">if</span>(argc &lt; 2){
<a name="l00038"></a>00038         printf(<span class="stringliteral">&quot;%s%s\n&quot;</span>, argv[0], help);
<a name="l00039"></a>00039         exit(-1);
<a name="l00040"></a>00040     }
<a name="l00041"></a>00041     c = NULL;
<a name="l00042"></a>00042         <span class="keywordflow">while</span>((h = getopt(argc, argv, <span class="stringliteral">&quot;c:d&quot;</span>)) != -1){
<a name="l00043"></a>00043                 <span class="keywordflow">switch</span>(h){
<a name="l00044"></a>00044                         <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
<a name="l00045"></a>00045                                 c = optarg;
<a name="l00046"></a>00046                                 <span class="keywordflow">break</span>;
<a name="l00047"></a>00047                         <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>:
<a name="l00048"></a>00048                                 do_daemonize = 1;
<a name="l00049"></a>00049                                 <span class="keywordflow">break</span>;
<a name="l00050"></a>00050                         <span class="keywordflow">default</span>:
<a name="l00051"></a>00051                                 printf(<span class="stringliteral">&quot;%s --help\n&quot;</span>, argv[0]);
<a name="l00052"></a>00052                                 exit(-1);
<a name="l00053"></a>00053                 }
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     <a class="code" href="config__global_8c.html#a8d05b5532d3ce63c362d9a6420cf8eaf">conn_init_global</a>();
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     <span class="keywordflow">if</span>(c){
<a name="l00059"></a>00059             <a class="code" href="conf__lib_8c.html#a4b6b3ad7301cf0d655270383fbc6880d">conf_init</a>(c);
<a name="l00060"></a>00060         <a class="code" href="config__global_8c.html#ab3fdc9ba0f0da4db729cec9b295fb6fb">conn_get_global</a>();
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062     
<a name="l00063"></a>00063 
<a name="l00064"></a>00064         <a class="code" href="log__lib_8c.html#a2b52cdbe46ce30c842d4ab36ca9fe052">d_log</a>(<span class="stringliteral">&quot;snooker:0.0.1 start ...&quot;</span>);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066         <span class="keywordflow">if</span>(do_daemonize == 1 || <a class="code" href="config__global_8h.html#a3675c593856f346d68d6f274d853e97e">conn_global</a>-&gt;do_daemonize == 1){
<a name="l00067"></a>00067                 <a class="code" href="daemon__lib_8c.html#a33cf8f9cc347978a6cf671e6b17f9c2b">daemon_init</a>(argv[0], 0);        
<a name="l00068"></a>00068                 <span class="keywordflow">if</span>(strlen(<a class="code" href="config__global_8h.html#a3675c593856f346d68d6f274d853e97e">conn_global</a>-&gt;pid_file) &gt; 0)strcpy(pid_file, <a class="code" href="config__global_8h.html#a3675c593856f346d68d6f274d853e97e">conn_global</a>-&gt;pid_file);
<a name="l00069"></a>00069                 <span class="keywordflow">else</span> strcpy(pid_file, <span class="stringliteral">&quot;/var/run/strawberry.pid&quot;</span>);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071                 <a class="code" href="daemon__lib_8c.html#a33ec14d4c4be87e5f390a880ebecd23d">save_pid</a>(getpid(), pid_file);
<a name="l00072"></a>00072         }
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="comment">/* register moduels </span>
<a name="l00075"></a>00075 <span class="comment">        modules_register();*/</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     unix_sock = <a class="code" href="config__global_8h.html#a3675c593856f346d68d6f274d853e97e">conn_global</a>-&gt;unix_sock;
<a name="l00078"></a>00078         <span class="keywordflow">if</span>(0 == unix_sock)
<a name="l00079"></a>00079                 listen_fd = <a class="code" href="socket__lib_8c.html#ae4aca315d84a8a70bd60f11280048efe">Socket_Init</a>();
<a name="l00080"></a>00080         <span class="keywordflow">else</span>
<a name="l00081"></a>00081                 listen_fd = <a class="code" href="socket__lib_8c.html#adbc6d31b97579067da5bcf680e1803b5">server_socket_unix</a>(); 
<a name="l00082"></a>00082 
<a name="l00083"></a>00083         <span class="keywordflow">if</span> (listen_fd &lt; 0){
<a name="l00084"></a>00084                 perror( <span class="stringliteral">&quot;listen failed&quot;</span>);
<a name="l00085"></a>00085                 exit(-1);
<a name="l00086"></a>00086         }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <a class="code" href="pool__init_8c.html#ae76fc3f05ff861e34389cc7982f99a22">hcreate</a>(8);
<a name="l00089"></a>00089     <span class="comment">//rq_init(MAXCONN);</span>
<a name="l00090"></a>00090     <a class="code" href="thread__lib_8c.html#a4cb09e57c69a74ac0a5e748e022957db">rq_init</a>(2);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <a class="code" href="thread__lib_8c.html#a91d70880b8de5d73665d2d9a7e46cd72">work_thread_init</a>(<a class="code" href="config__global_8h.html#a3675c593856f346d68d6f274d853e97e">conn_global</a>-&gt;process_num);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     <a class="code" href="thread__lib_8c.html#a3de5c4c46593aca56c44b3482d3f83bf">token_thread_init</a>();
<a name="l00095"></a>00095     <a class="code" href="thread__lib_8h.html#a3fee839a6d9eee1090fa3987088be641">notify_token_thread</a> = <a class="code" href="thread__lib_8h.html#a3a97eb94bafe8d0c241194c797baaa86a62bdc3f2c5393dadc42e869a57846011">NT_FREE</a>;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <a class="code" href="thread__lib_8h.html#ab2007460e3f06398c4264137c1a06075">main_base</a> = event_init();
<a name="l00098"></a>00098     <a class="code" href="action__lib_8c.html#aff993b0c4844f0b3fa9336f377488b13">conn_new</a>(listen_fd, <a class="code" href="thread__lib_8h.html#ab2007460e3f06398c4264137c1a06075">main_base</a>);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     event_base_loop(<a class="code" href="thread__lib_8h.html#ab2007460e3f06398c4264137c1a06075">main_base</a>, 0);
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">return</span> 0;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">/* vim: set ts=4 sw=4: */</span>
<a name="l00106"></a>00106 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 23 Dec 2013 for fdbc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
